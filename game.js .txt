let hero = null;
let enemy = null;

const classes = {
  "Spellblade": "A balanced arcane warrior who channels magic through melee strikes.",
  "Grim Herald": "A dark mage who sacrifices vitality to unleash cursed devastation.",
  "Beastheart": "A primal tamer that fights alongside summoned wild familiars.",
  "Stormbreaker": "A thunder-armored tank that controls lightning and shields allies.",
  "Dawnpriest": "A radiant healer who restores allies and burns foes with holy light."
};

function showClassInfo(selected) {
  const chosen = selected || document.getElementById("classSelect").value;
  document.getElementById("class-title").innerText = chosen;
  document.getElementById("class-desc").innerText = classes[chosen];
  document.getElementById("classModal").classList.remove("hidden");
}

function closeModal() {
  document.getElementById("classModal").classList.add("hidden");
}

function rollStat() {
  let r=[1,2,3,4,5].map(()=>Math.ceil(Math.random()*6));
  r.sort(); r.splice(0,2);
  return r.reduce((a,b)=>a+b,0);
}

function createHero() {
  hero = {
    name: heroName.value || "Hero",
    race: raceSelect.value,
    class: classSelect.value,
    level: 1,
    xp: 0,
    stats: {
      STR: rollStat(), DEX: rollStat(), CON: rollStat(),
      INT: rollStat(), WIS: rollStat(), CHA: rollStat()
    },
    hp: 100,
    mp: 50
  };
  saveHero();
  loadHUD();
  goTo("screen-hud");
}

function saveHero(){ localStorage.setItem("hero", JSON.stringify(hero)); }
function loadHero(){
  let saved = localStorage.getItem("hero");
  if(saved){ hero = JSON.parse(saved); loadHUD(); goTo("screen-hud"); }
}
function clearHero(){ localStorage.removeItem("hero"); location.reload(); }

function loadHUD() {
  document.getElementById("hud-name").innerText = hero.name;
  document.getElementById("hud-race").innerText = hero.race;
  document.getElementById("hud-class").innerText = hero.class;
  document.getElementById("hud-level").innerText = `Level ${hero.level} (XP ${hero.xp}/${hero.level*100})`;

  hp-fill.style.width = hero.hp+"%";
  mp-fill.style.width = hero.mp*2+"%";

  hud-stats.innerHTML = "";
  for(let s in hero.stats) hud-stats.innerHTML += `${s}: ${hero.stats[s]}<br>`;
}

function startEncounter() {
  enemy = { name:"Void Crawler", hp:80 };
  document.getElementById("enemy-name").innerText = enemy.name;
  updateEnemyHP();
  log("A wild Void Crawler appears!");
  goTo("screen-combat");
}

function playerAttack() {
  let dmg = 6 + Math.floor(hero.stats.STR/2);
  enemy.hp -= dmg;
  log(`You strike for ${dmg} damage!`);
  updateEnemyHP();

  if(enemy.hp <= 0){
    log("Enemy defeated! +20 XP");
    hero.xp += 20;
    saveHero();
    setTimeout(()=>goTo("screen-hud"), 1500);
  } else enemyTurn();
}

function enemyTurn(){
  let dmg = 5;
  hero.hp -= dmg;
  log(`Enemy hits you for ${dmg}!`);
  saveHero();
  loadHUD();
  if(hero.hp <= 0) log("You were defeated...");
}

function updateEnemyHP() {
  enemy-hp-bar.style.width = Math.max(enemy.hp,0)+"%";
}

function endEncounter(){ goTo("screen-hud"); }

function log(msg){
  battle-log.innerHTML += msg+"<br>";
  battle-log.scrollTop = battle-log.scrollHeight;
}

function goTo(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

window.onload = loadHero;
